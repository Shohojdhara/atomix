@use '../01-settings/settings.config' as *;
@use '../01-settings/settings.chart' as *;
@use '../01-settings/settings.colors' as *;
@use '../01-settings/settings.spacing' as *;
@use '../01-settings/settings.typography' as *;
@use '../01-settings/settings.border-radius' as *;
@use '../01-settings/settings.box-shadow' as *;
@use '../01-settings/settings.maps' as color-maps;
@use '../02-tools/tools.component' as *;
@use '../02-tools/tools.rem' as *;
@use '../02-tools/tools.animations' as *;
@use '../02-tools/tools.background' as *;

@use 'sass:map';

.c-chart {
  $root: &;

  --#{$prefix}chart-primary-color: #{$chart-primary-color};
  --#{$prefix}chart-secondary-color: #{$chart-secondary-color};
  --#{$prefix}chart-border-radius: #{$chart-border-radius};
  --#{$prefix}chart-padding: #{$chart-padding};
  --#{$prefix}chart-gap: #{$chart-gap};
  --#{$prefix}chart-border-width: #{$chart-border-width};
  --#{$prefix}chart-border-color: #{$chart-border-color};
  --#{$prefix}chart-bg: #{$chart-bg};
  --#{$prefix}chart-min-height: #{$chart-min-height};

  display: flex;
  flex-direction: column;
  border: var(--#{$prefix}chart-border-width) solid var(--#{$prefix}chart-border-color);
  border-radius: var(--#{$prefix}chart-border-radius);
  overflow: hidden;
  box-shadow: $box-shadow-sm;
  position: relative;
  min-height: var(--#{$prefix}chart-min-height);
  width: 100%;
  max-width: 100%;
  @include dynamic-background(var(--#{$prefix}chart-bg));
  @include basic-transition();

  &::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      rgba(var(--#{$prefix}primary-rgb), 0.1) 0%,
      transparent 50%,
      rgba(var(--#{$prefix}secondary-rgb), 0.05) 100%
    );
    pointer-events: none;
    z-index: 1;
  }

  &:hover {
    box-shadow: $box-shadow-lg;
    border-color: var(--#{$prefix}primary-border-subtle);
  }


  &--loading {
    #{$root}__content {
      position: relative;
      overflow: hidden;

      &::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: chart-shimmer 2s infinite;
      }
    }

    #{$root}__canvas {
      opacity: 0.3;
      filter: blur(1px);
    }
  }

  &--fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    border-radius: 0;
    box-shadow: none;
    background: var(--#{$prefix}body-bg);
  }
  &--elevated {
    box-shadow: $box-shadow-lg;
    transform: translateY(-2px);

    &:hover {
      box-shadow: $box-shadow-xl;
      transform: translateY(-4px);
    }
  }


  &__header {
    padding: var(--#{$prefix}chart-padding);
    border-bottom: var(--#{$prefix}chart-border-width) solid var(--#{$prefix}brand-bg-subtle);
    backdrop-filter: blur($chart-header-backdrop-blur);
    position: relative;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--#{$prefix}chart-gap);
    z-index: 2;

    &::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: var(--#{$prefix}chart-padding);
      right: var(--#{$prefix}chart-padding);
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        var(--#{$prefix}brand-border-subtle),
        transparent
      );
    }
  }

  &__header-content {
    flex: 1;
    min-width: 0;
  }

  &__title {
    margin: 0 0 $chart-title-spacer-y 0;
    font-size: $chart-title-font-size;
    font-weight: $chart-title-font-weight;
    color: $chart-title-color;
    letter-spacing: -0.02em;
    line-height: 1.3;
    word-wrap: break-word;
    hyphens: auto;
  }

  &__subtitle {
    margin: 0;
    color: $chart-subtitle-color;
    opacity: 0.8;
    line-height: 1.4;
    word-wrap: break-word;
  }

  &__toolbar {
    display: flex;
    align-items: center;
    gap: var(--#{$prefix}chart-gap);
    flex-shrink: 0;
    margin-left: auto;
    padding: map.get($spacing-sizes, 1);
    border-radius: $border-radius-md;
    background: var(--#{$prefix}primary-bg-subtle);
    backdrop-filter: blur(8px);
    border: 1px solid var(--#{$prefix}primary-border-subtle);
    box-shadow: $box-shadow-sm;
    transition: all $chart-transition-duration $chart-transition-timing;

    &:hover {
      box-shadow: $box-shadow-md;
      background: var(--#{$prefix}primary-bg-default);
    }
  }

  &__action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: rem(32px);
    height: rem(32px);
    border-radius: $border-radius-sm;
    border: 1px solid transparent;
    background-color: transparent;
    color: var(--#{$prefix}secondary-text-emphasis);
    cursor: pointer;
    transition: all $chart-transition-duration $chart-transition-timing;
    position: relative;
    overflow: hidden;
    font-size: rem(14px);

    &::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--#{$prefix}primary-6);
      opacity: 0;
      border-radius: inherit;
      transition: opacity $chart-transition-duration $chart-transition-timing;
    }

    svg {
      position: relative;
      z-index: 1;
      width: rem(16px);
      height: rem(16px);
      transition: transform $chart-transition-duration $chart-transition-timing;
    }

    &:hover {
      background-color: var(--#{$prefix}primary-bg-subtle);
      color: var(--#{$prefix}primary-text-emphasis);
      border-color: var(--#{$prefix}primary-border-subtle);
      transform: translateY(-1px);
      box-shadow: $box-shadow-sm;

      &::before {
        opacity: 0.1;
      }

      svg {
        transform: scale(1.1);
      }
    }

    &:focus-visible {
      outline: 2px solid var(--#{$prefix}primary-6);
      outline-offset: 2px;
      border-color: var(--#{$prefix}primary-border-subtle);
    }

    &:active {
      transform: translateY(0);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);

      &::before {
        opacity: 0.2;
      }

      svg {
        transform: scale(0.95);
      }
    }

    &:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
      transform: none;
      box-shadow: none;

      &:hover {
        transform: none;
        box-shadow: none;
        background-color: transparent;
        border-color: transparent;
      }
    }
  }

  &__export-group {
    position: relative;
    display: flex;
    align-items: center;
    gap: map.get($spacing-sizes, 1);

    &:hover {
      #{$root}__export-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
    }
  }

  &__export-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: map.get($spacing-sizes, 1);
    background: var(--#{$prefix}primary-bg-default);
    border: 1px solid var(--#{$prefix}primary-border-subtle);
    border-radius: $border-radius-md;
    box-shadow: $box-shadow-lg;
    padding: map.get($spacing-sizes, 1);
    min-width: rem(120px);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all $chart-transition-duration $chart-transition-timing;
    backdrop-filter: blur(8px);
  }

  &__export-option {
    display: block;
    width: 100%;
    padding: map.get($spacing-sizes, 2) map.get($spacing-sizes, 3);
    border: none;
    background: transparent;
    color: var(--#{$prefix}primary-text-emphasis);
    font-size: rem(12px);
    font-weight: $font-weight-medium;
    text-align: left;
    border-radius: $border-radius-sm;
    cursor: pointer;
    transition: all $chart-transition-duration $chart-transition-timing;
    text-transform: uppercase;
    letter-spacing: 0.5px;

    &:hover {
      background-color: var(--#{$prefix}primary-bg-subtle);
      color: var(--#{$prefix}primary-text-emphasis);
    }

    &:focus-visible {
      outline: 2px solid var(--#{$prefix}primary-6);
      outline-offset: -2px;
    }

    &:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    &:not(:last-child) {
      margin-bottom: map.get($spacing-sizes, 1);
    }
  }

  &__content {
    flex: 1;
    position: relative;
    padding: var(--#{$prefix}chart-padding);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: $chart-canvas-min-height;

    &::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: radial-gradient(
        circle at 1px 1px,
        var(--#{$prefix}primary-border-subtle) 1px,
        transparent 0
      );
      background-size: $chart-pattern-size $chart-pattern-size;
      opacity: $chart-pattern-opacity;
      pointer-events: none;
      z-index: 0;
    }

    &::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.02) 0%,
        transparent 50%,
        rgba(0, 0, 0, 0.02) 100%
      );
      pointer-events: none;
      z-index: 1;
    }
  }

  &__canvas {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    border-radius: $border-radius-sm;
    z-index: 2;

    svg {
      width: 100%;
      height: 100%;
      shape-rendering: geometricPrecision;
      text-rendering: optimizeLegibility;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    canvas {
      width: 100%;
      height: 100%;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
  }


  &__tooltip {
    position: fixed;
    backdrop-filter: blur($chart-tooltip-backdrop-blur);
    border-radius: $chart-tooltip-border-radius;
    padding: $chart-tooltip-padding-y $chart-tooltip-padding-x;
    box-shadow: var(--atomix-box-shadow);
    font-size: $chart-tooltip-font-size;
    color: $chart-primary-text;
    pointer-events: none;
    z-index: 1070;
    max-width: $chart-tooltip-max-width;
    min-width: $chart-tooltip-min-width;
    // background: $chart-primary-bg;
    border: 1px solid $chart-primary-border;
    opacity: 1;

    &-title {
      font-weight: $font-weight-bold;
      margin-bottom: map.get($spacing-sizes, 2);
      color: $chart-primary-text;
      font-size: $font-size-sm;
    }

    &-content {
      display: flex;
      flex-direction: column;
      gap: map.get($spacing-sizes, 1);
    }

    &-dataset {
      display: flex;
      align-items: center;
      gap: map.get($spacing-sizes, 2);
    }

    &-color-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    &-dataset-label {
      color: $chart-secondary-text;
      font-size: $font-size-xs;
    }

    &-value {
      font-weight: $font-weight-semibold;
      color: $chart-primary-text;
      font-size: $font-size-xs;
    }

    &-metadata {
      margin-top: map.get($spacing-sizes, 2);
      padding-top: map.get($spacing-sizes, 2);
      border-top: 1px solid $chart-primary-border;
    }

    &-metadata-item {
      display: flex;
      justify-content: space-between;
      font-size: $font-size-xs;
      margin-bottom: map.get($spacing-sizes, 1);

      &:last-child {
        margin-bottom: 0;
      }
    }

    &-metadata-key {
      color: $chart-secondary-text;
    }

    &-metadata-value {
      color: $chart-primary-text;
      font-weight: $font-weight-medium;
    }
  }


  &__grid {
    stroke: $chart-primary-border;
    stroke-width: $chart-grid-stroke-width;
    stroke-dasharray: 2, 4;

    &--major {
      stroke-width: $chart-grid-major-stroke-width;
      stroke-dasharray: none;
      opacity: $chart-grid-major-opacity;
    }

    &--minor {
      opacity: $chart-grid-minor-opacity;
    }

    &--zero {
      stroke-width: $chart-grid-zero-stroke-width;
      stroke-dasharray: none;
      opacity: $chart-grid-zero-opacity;
    }
  }

  &__data-point {
    cursor: pointer;
    transition: all $chart-transition-duration $chart-transition-timing;

    &:hover {
      opacity: 0.8;
    }

    &:focus-visible {
      outline: 2px solid var(--#{$prefix}primary-border-subtle);
      outline-offset: 2px;
    }
  }
  &__empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: map.get($spacing-sizes, 4);
    color: var(--#{$prefix}secondary-text-emphasis);
    font-size: $font-size-sm;
    text-align: center;
    padding: map.get($spacing-sizes, 8);
    min-height: $chart-canvas-min-height;
    opacity: 0.6;

    animation: chart-fade-in 0.6s ease-out;
  }
}
