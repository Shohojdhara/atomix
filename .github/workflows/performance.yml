name: Performance Testing

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run weekly on Mondays
    - cron: '0 0 * * 1'

jobs:
  performance:
    name: Performance Budget Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check bundle sizes
        id: bundle_check
        run: |
          echo "Checking bundle sizes against performance budgets..."
          
          # Check core bundle (recommended entry point for core components)
          if [ ! -f "dist/core.js" ]; then
            echo "❌ Core bundle file not found: dist/core.js"
            echo "core_status=❌ Build failed - file not found" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          CORE_SIZE=$(stat -f%z dist/core.js 2>/dev/null || stat -c%s dist/core.js 2>/dev/null)
          CORE_BUDGET=245760 # 240KB (realistic budget for core components, encourages optimization)
          
          if [ "$CORE_SIZE" -eq 0 ]; then
            echo "❌ Core bundle has zero size - build may have failed"
            echo "core_status=❌ Zero-sized bundle" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ "$CORE_SIZE" -gt "$CORE_BUDGET" ]; then
            echo "❌ Core bundle size ($CORE_SIZE bytes) exceeds budget ($CORE_BUDGET bytes)"
            echo "core_status=❌ Exceeds budget ($CORE_SIZE bytes > $CORE_BUDGET bytes)" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "✅ Core bundle size ($CORE_SIZE bytes) is within budget ($CORE_BUDGET bytes)"
            echo "core_status=✅ Within budget ($CORE_SIZE bytes / $CORE_BUDGET bytes)" >> $GITHUB_OUTPUT
          fi
          
          # Check main bundle (informational - expected to be large as it includes everything)
          if [ ! -f "dist/index.esm.js" ]; then
            echo "⚠️ Main bundle file not found: dist/index.esm.js"
            echo "main_status=⚠️ File not found" >> $GITHUB_OUTPUT
          else
            MAIN_SIZE=$(stat -f%z dist/index.esm.js 2>/dev/null || stat -c%s dist/index.esm.js 2>/dev/null)
            echo "ℹ️ Main bundle size: $MAIN_SIZE bytes (informational - includes all components)"
            echo "main_status=ℹ️ $MAIN_SIZE bytes (all components)" >> $GITHUB_OUTPUT
          fi
          
          # Check CSS bundle
          if [ ! -f "dist/atomix.min.css" ]; then
            echo "❌ CSS bundle file not found: dist/atomix.min.css"
            echo "css_status=❌ Build failed - file not found" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          CSS_SIZE=$(stat -f%z dist/atomix.min.css 2>/dev/null || stat -c%s dist/atomix.min.css 2>/dev/null)
          CSS_BUDGET=409600 # 400KB (realistic budget for full design system CSS)
          
          if [ "$CSS_SIZE" -eq 0 ]; then
            echo "❌ CSS bundle has zero size - build may have failed"
            echo "css_status=❌ Zero-sized bundle" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ "$CSS_SIZE" -gt "$CSS_BUDGET" ]; then
            echo "❌ CSS bundle size ($CSS_SIZE bytes) exceeds budget ($CSS_BUDGET bytes)"
            echo "css_status=❌ Exceeds budget ($CSS_SIZE bytes > $CSS_BUDGET bytes)" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "✅ CSS bundle size ($CSS_SIZE bytes) is within budget ($CSS_BUDGET bytes)"
            echo "css_status=✅ Within budget ($CSS_SIZE bytes / $CSS_BUDGET bytes)" >> $GITHUB_OUTPUT
          fi
          
          echo "All bundle sizes are within budget!"

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:6006
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./.lighthouserc.json

      - name: Performance Budget Report
        if: always()
        run: |
          echo "## Performance Budget Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundle Sizes" >> $GITHUB_STEP_SUMMARY
          echo "- Core bundle: ${{ steps.bundle_check.outputs.core_status || '⚠️ Check did not complete' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Main bundle: ${{ steps.bundle_check.outputs.main_status || '⚠️ Check did not complete' }}" >> $GITHUB_STEP_SUMMARY
          echo "- CSS bundle: ${{ steps.bundle_check.outputs.css_status || '⚠️ Check did not complete' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "See Lighthouse CI artifacts for detailed scores." >> $GITHUB_STEP_SUMMARY

